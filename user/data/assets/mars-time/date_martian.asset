-- 1. Define the renderable
local MarsClock = {
  Type = "ScreenSpaceText",
  Identifier = "MarsClock",
  Name = "Mars Clock",
  Text = "MTC: Calculating...",
  FontSize = 50,
  Position = {0.8, 0.9},
  Color = {1.0, 0.4, 0.2}
}

-- 2. Define the update function GLOBALLY so OpenSpace can find it later.
-- We use a unique name (MyMars_Update) to avoid conflicts with other scripts.
function MyMars_Update()
    -- Get time
    local j2000 = openspace.time.currentTime()
    local jd_ut = 2451545.0 + (j2000 / 86400.0)

    -- MSD Calculation (Allison & McEwen 2000)
    local msd = (jd_ut - 2451545.0) / 1.027491252 + 44796.0 - 0.00096

    -- MTC Calculation
    local msd_fraction = msd % 1.0
    local mtc_hours = msd_fraction * 24.0
    local mtc_minutes = (mtc_hours % 1.0) * 60.0
    local mtc_seconds = (mtc_minutes % 1.0) * 60.0

    local timeString = string.format("Sol %d  %02d:%02d:%02d MTC",
        math.floor(msd),
        math.floor(mtc_hours),
        math.floor(mtc_minutes),
        math.floor(mtc_seconds)
    )

    -- Safety check: Ensure the renderable exists before setting text
    if openspace.hasProperty("ScreenSpace.MarsClock.Text") then
        openspace.setPropertyValueSingle("ScreenSpace.MarsClock.Text", timeString)
    end
end

asset.onInitialize(function()
  openspace.addScreenSpaceRenderable(MarsClock)
  
  -- Run once immediately
  MyMars_Update()

  -- 3. Register the script.
  -- CORRECT API: openspace.registerRepeatedScript (not scriptScheduler)
  -- CORRECT ARG: Pass the string "MyMars_Update()" (not the function object)
  openspace.registerRepeatedScript("UpdateMarsClock", "MyMars_Update()", 0)
end)

asset.onDeinitialize(function()
  -- Remove the script
  openspace.removeRepeatedScript("UpdateMarsClock")
  
  -- Remove the renderable
  openspace.removeScreenSpaceRenderable("MarsClock")
end)
