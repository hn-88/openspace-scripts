<html>
	<!-- require this so that apostrophes don't become all weird. -->
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<head>
			
		<title>OpenSpace Keyframe concatenation</title>
		<link rel="stylesheet" type="text/css" href="main2.css">
		<script type="text/javascript" src="openspace-api.js"></script>
		<script type="text/javascript">
            // Hari Nandakumar Sep-Oct 2025            
            // Modified from the code by    			
            // Jeff Nee at NASA's Museum & Informal Education Alliance at JPL
			//Last updated: May 2024
			//At the bottom of the page are the button messages that you can customize for prenters, search for "var buttonMessages"

			//Thanks to ChatGPT for some code.
			
			//These are variables to customize for your own dome as needed/desired:
			//wherever your content will be on your local machine
			var contentPath = "/home/sssvv/Downloads/openspace-scripts-main/OpenSpace-ConstellationsTonight_draft/";
			var recordingsPath = "/home/sssvv/OpenSpace/user/recordings/";
			alert('recordingsPath is set to "' + recordingsPath + '".\nThis folder needs to be writable by OpenSpace for this program to work.\n You will need to edit the html file for doing this.\n On Windows, the path should have / instead of backslash - for example,\n D:/OpenSpace/user/recordings');
			
			//These are functional variables that are needed for the interface to work
			//resetting the openspace interface:
			var openspace = null;

			// Array to store up to 20 navstates
            var navstates = new Array(20).fill(null);

            
			
			function ChangeDescription(sectionName,presenterScript) {
				//function to display a presenter script when a button is pressed
				//clear it
				document.getElementById(sectionName).innerHTML = "";
				//Then add the text
				document.getElementById(sectionName).innerHTML += presenterScript;
				//This is specifcially for the NavState Programming button, turning an object into a string:
				if (typeof presenterScript !== "string") {
					presenterScript.then(x => myDisplay(x));
					function myDisplay(navObj) {
						document.getElementById(sectionName).innerHTML = JSON.stringify(navObj);
					}
				}
			}
			

			
			var setFocus = (focus) => {
				openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.Anchor', focus);
				openspace.setPropertyValue('NavigationHandler.OrbitalNavigator.RetargetAnchor', null);
			}
			//functions to start and stop rotation of the camera:
			var rotateCamera = 0;
			function StartOrbit() {
				rotateCamera = 1;
				var globalRotation = setInterval(()=>{
					openspace.navigation.addGlobalRotation(1,0)
					if (rotateCamera != 1) {
						clearInterval(globalRotation);
						openspace.navigation.addGlobalRotation(0,0)
					}
				},500);
			}

			function StopOrbit() {
				rotateCamera = 0;
			}
			function TemporaryStopOrbit(){
				if (rotateCamera == 1) {
					//stop orbit first
					StopOrbit();
					document.getElementById('Orbit').className = '';
					//if it was already going, assume that you want to restart it after the flight
					setTimeout(() => {
						StartOrbit();
						document.getElementById('Orbit').className = 'clicked';
					},flightDuration*1000+1000)
				}
			}
			function findMessageByButtonName(array, targetButtonName) {
				for (let i = 0; i < array.length; i++) {
					if (array[i].buttonName === targetButtonName) {
						return array[i].message;
					}
				}
				return "No message";  // Return null if no match is found
			}
            async function addFlyToScript(index) {
                try {
                    let prevSimTime = parseFloat(document.getElementById('simtime' + (index - 1)).value);
					let currSimTime = parseFloat(document.getElementById('simtime' + index).value);
					let timeSimdiff = currSimTime - prevSimTime;
					let destinationNavStateObj = await navstates[index - 1];  // Wait for navstate to resolve
                    // Create the script string for previous index
                    let scriptstring = "openspace.navigation.flyToNavigationState("+JSON.stringify(destinationNavStateObj)+", "+timeSimdiff+")";
                    openspace.keyframeRecording.addScriptKeyframe(prevSimTime, scriptstring);
                    // Output or use scriptstring as needed for each index
                     console.log(`Index ${index}: ${scriptstring}`);
                } catch (error) {
                    console.error("Error processing flyto script:", error);
                }
            }

//buttons start here

            // Define buttons for saving keyframes
            var keyframeButtons = {
			  title: "Keyframe Recorder",
			  description: "Save navigation states with optional sim-time to next keyframe",
			  buttons: {
			    'Save keyframe 1': () => {
                  navstates[0] = openspace.navigation.getNavigationState();
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime1').value);
                  document.getElementById('keyframeStatus1').textContent =
                    'NavState saved at ' + document.getElementById('simtime1').value;
                },
                'Save keyframe 2': () => {
                  navstates[1] = openspace.navigation.getNavigationState();
                  addFlyToScript(2);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime2').value);
                  document.getElementById('keyframeStatus2').textContent =
                    'NavState saved at ' + document.getElementById('simtime2').value;
                },
                'Save keyframe 3': () => {
                  navstates[2] = openspace.navigation.getNavigationState();
                  addFlyToScript(3);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime3').value);
                  document.getElementById('keyframeStatus3').textContent =
                    'NavState saved at ' + document.getElementById('simtime3').value;
                },
                'Save keyframe 4': () => {
                  navstates[3] = openspace.navigation.getNavigationState();
                  addFlyToScript(4);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime4').value);
                  document.getElementById('keyframeStatus4').textContent =
                    'NavState saved at ' + document.getElementById('simtime4').value;
                },
                'Save keyframe 5': () => {
                  navstates[4] = openspace.navigation.getNavigationState();
                  addFlyToScript(5);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime5').value);
                  document.getElementById('keyframeStatus5').textContent =
                    'NavState saved at ' + document.getElementById('simtime5').value;
                },
                'Save keyframe 6': () => {
                  navstates[5] = openspace.navigation.getNavigationState();
                  addFlyToScript(6);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime6').value);
                  document.getElementById('keyframeStatus6').textContent =
                    'NavState saved at ' + document.getElementById('simtime6').value;
                },
                'Save keyframe 7': () => {
                  navstates[6] = openspace.navigation.getNavigationState();
                  addFlyToScript(7);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime7').value);
                  document.getElementById('keyframeStatus7').textContent =
                    'NavState saved at ' + document.getElementById('simtime7').value;
                },
                'Save keyframe 8': () => {
                  navstates[7] = openspace.navigation.getNavigationState();
                  addFlyToScript(8);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime8').value);
                  document.getElementById('keyframeStatus8').textContent =
                    'NavState saved at ' + document.getElementById('simtime8').value;
                },
                'Save keyframe 9': () => {
                  navstates[8] = openspace.navigation.getNavigationState();
                  addFlyToScript(9);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime9').value);
                  document.getElementById('keyframeStatus9').textContent =
                    'NavState saved at ' + document.getElementById('simtime9').value;
                },
                'Save keyframe 10': () => {
                  navstates[9] = openspace.navigation.getNavigationState();
                  addFlyToScript(10);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime10').value);
                  document.getElementById('keyframeStatus10').textContent =
                    'NavState saved at ' + document.getElementById('simtime10').value;
                },
                'Save keyframe 11': () => {
                  navstates[10] = openspace.navigation.getNavigationState();
                  addFlyToScript(11);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime11').value);
                  document.getElementById('keyframeStatus11').textContent =
                    'NavState saved at ' + document.getElementById('simtime11').value;
                },
                'Save keyframe 12': () => {
                  navstates[11] = openspace.navigation.getNavigationState();
                  addFlyToScript(12);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime12').value);
                  document.getElementById('keyframeStatus12').textContent =
                    'NavState saved at ' + document.getElementById('simtime12').value;
                },
                'Save keyframe 13': () => {
                  navstates[12] = openspace.navigation.getNavigationState();
                  addFlyToScript(13);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime13').value);
                  document.getElementById('keyframeStatus13').textContent =
                    'NavState saved at ' + document.getElementById('simtime13').value;
                },
                'Save keyframe 14': () => {
                  navstates[13] = openspace.navigation.getNavigationState();
                  addFlyToScript(14);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime14').value);
                  document.getElementById('keyframeStatus14').textContent =
                    'NavState saved at ' + document.getElementById('simtime14').value;
                },
                'Save keyframe 15': () => {
                  navstates[14] = openspace.navigation.getNavigationState();
                  addFlyToScript(15);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime15').value);
                  document.getElementById('keyframeStatus15').textContent =
                    'NavState saved at ' + document.getElementById('simtime15').value;
                },
                'Save keyframe 16': () => {
                  navstates[15] = openspace.navigation.getNavigationState();
                  addFlyToScript(16);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime16').value);
                  document.getElementById('keyframeStatus16').textContent =
                    'NavState saved at ' + document.getElementById('simtime16').value;
                },
                'Save keyframe 17': () => {
                  navstates[16] = openspace.navigation.getNavigationState();
                  addFlyToScript(17);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime17').value);
                  document.getElementById('keyframeStatus17').textContent =
                    'NavState saved at ' + document.getElementById('simtime17').value;
                },
                'Save keyframe 18': () => {
                  navstates[17] = openspace.navigation.getNavigationState();
                  addFlyToScript(18);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime18').value);
                  document.getElementById('keyframeStatus18').textContent =
                    'NavState saved at ' + document.getElementById('simtime18').value;
                },
                'Save keyframe 19': () => {
                  navstates[18] = openspace.navigation.getNavigationState();
                  addFlyToScript(19);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime19').value);
                  document.getElementById('keyframeStatus19').textContent =
                    'NavState saved at ' + document.getElementById('simtime19').value;
                },
                'Save keyframe 20': () => {
                  navstates[19] = openspace.navigation.getNavigationState();
                  addFlyToScript(20);
                  openspace.keyframeRecording.addCameraKeyframe(document.getElementById('simtime20').value);
                  document.getElementById('keyframeStatus20').textContent =
                    'NavState saved at ' + document.getElementById('simtime20').value;
                },


			  },
			};

			

			var programmingButtons = {
				title: "Programming Buttons",
				description: "Use this to find your NavState for customized flying sequences",
				buttons: {
					'Show Nav State': () => {
						var navState = openspace.navigation.getNavigationState();
						//console.log(navState);
						ChangeDescription(programmingButtons.title,navState);
						
					},
					'Clear Keyframe Sequence': () => {
					  openspace.keyframeRecording.newSequence();
					  // console.log('double quotes cause error, Unexpected end of input');
					  ChangeDescription(programmingButtons.title,'Keyframe sequence cleared.');	
                      setTimeout(() => {
                        window.location.reload();
                      }, 1500);		
					}
				}
			};
			
			var templateButtons = {
				title: "title_name",
				description: " ",
				buttons: {
					'button1': () => {
					},
					'togglebutton1': async () => {
						if (this.className != 'clicked') { 
							setTimeout(() => {
							}, 100)
							this.className = 'clicked';
						} else {
							setTimeout(() => {
							}, duration*1000+100)
							this.className = '';
						}
					},
				},
			};
			
//end of buttons			
			var buttonGroups = [programmingButtons, keyframeButtons];

			
//OpenSpace Connecting and Mapping buttons		
			function mapButtons(openspace) {
				buttonGroups.map((action, id) => {
					var cardIndex = '';
					if( id % 2 == 1 ) {
						cardIndex = "1";
					}
					var cardHTML = "<div class='card" + cardIndex +"'><h2>" + action.title + "</h2>";
					if (action.buttons) {
						Object.keys(action.buttons).map(button => {
							const fn = action.buttons[button];
							if (button.startsWith("Save keyframe")) {
                                let index = button.split(" ")[2]; // gets "1".."20"
                                cardHTML += '<div>';
                                cardHTML += '<button id="' + button + '" onClick="(' + fn + ')(event)">' + button + '</button>';
                                cardHTML += ' <input type="number" id="simtime' + index + '" value=' + (index-1)*10 + ' style="width:120px; margin-left:10px;"><label for="simtime' + index + '">sim-time (sec)</label>';
								cardHTML += '<span id="keyframeStatus' + index + '" style="margin-left:10px;"></span>';
                                cardHTML += '</div>';
                            } else {
                                cardHTML += '<button id="' + button + '" onClick="(' + fn + ')(event)">' + button + '</button>';
                            }
							
						});
					}
					if (action.description) {
						action.description.split('\n').map(item => {
							cardHTML += "<p id='" + action.title + "'>" + item + "</p>";
						});
					}					
					cardHTML += "</div>";
					document.getElementById('main').innerHTML += cardHTML;
					
				})
			}
			
			var connectToOpenSpace = () => {
				var host = document.getElementById('ipaddress').value;
				var api = window.openspaceApi(host, 4682);
				api.onDisconnect(() => {
					console.log("disconnected");
					document.getElementById('container').className = "disconnected";
					var disconnectedString = "Unable to connect, please run OpenSpace: ";
					disconnectedString += '<input id="ipaddress" type=text placeholder="Enter IP address" /> ';
					disconnectedString += '<button onClick="connectToOpenSpace();">Connect</button>';
					document.getElementById('connection-status').innerHTML = disconnectedString;
					openspace = null;
				});
				api.onConnect(async () => {
					try {
						document.getElementById('container').className = "connected";
						document.getElementById('connection-status').innerHTML = "Connected to OpenSpace";
						openspace = await api.library();
						console.log('connected');
						//wipe the page first before building the buttons
						document.getElementById('main').innerHTML = '';
						mapButtons(openspace);
					} catch (e) {
						console.log('OpenSpace library could not be loaded: Error: \n', e)
						return;
					}
				})
				api.connect();
			};
		</script>
	</head>

	<body>
		
		<div class="navbar">
			<h1>Keyframe concatenation in OpenSpace
			
		</div>
		<div id="container" class="disconnected">
			<div id="connection-status" class="connection-status">
				Connect to OpenSpace:
				<input id='ipaddress' type=text placeholder="Enter IP address" />
				<button onClick="connectToOpenSpace();">Connect</button>
			</div>\

			<div id="main" class="generatedButtons">
			</div>
			<script type="text/javascript">
				connectToOpenSpace('localhost');
			</script>

<button id="SaveAllKeyframes" onclick="saveSequence()">Save Sequence as OSRECTXT</button><span id="saveSeqStatus" style="margin-left:10px; color:#eee;">Sequence saving status.</span></div>

<script>


async function saveSequence() {
  try {
    const now = new Date();
    const pad = n => String(n).padStart(2, "0");
    const timestamp = [
      now.getFullYear(),
      pad(now.getMonth() + 1),
      pad(now.getDate()),
      pad(now.getHours()),
      pad(now.getMinutes()),
      pad(now.getSeconds())
    ].join("-");

    const filename = `concat-${timestamp}.osrectxt`;
    const recfilefullpath = recordingsPath + filename;

    // If saveSequence is async
    await openspace.keyframeRecording.saveSequence(recfilefullpath);

    document.getElementById('saveSeqStatus').textContent =
      'Sequence saved as ' + recfilefullpath;
  } catch (err) {
    console.error('Error saving sequence:', err);
    document.getElementById('saveSeqStatus').textContent =
      'Error saving sequence: ' + err.message;
  }
}

</script>

			<p>Please report issues at <a href="https://github.com/hn-88/openspace-scripts/issues" target=_blank>https://github.com/hn-88/openspace-scripts/issues</a></p>
		</div>
	</body>
</html>

